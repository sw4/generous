function getNestedChildren(e,r){var t=[];for(var n in e)if(e[n].parent==r){var o=getNestedChildren(e,e[n].name);o.length&&(e[n].children=o),t.push(e[n])}return t}function trim(e){var r,t=9999,n=RegExp.prototype.test.bind(/^\s*$/),o=e.split("\n"),s=t,a=" "!=o[0][0]&&o.length>1;o.forEach(function(e){if(a)return void(a=!1);var r=e.match(/^\s*/)[0].length;(r>0||s==t)&&(s=Math.min(s,r))}),r=new RegExp("^\\s{0,"+s+"}");for(var i=0;i<o.length;i++)o[i]=o[i].replace(r,"");for(;n(o[0]);)o.shift();for(;n(o[o.length-1]);)o.pop();return o.join("\n")}function parseExample(e,r){function t(r){var t="<"+r+">",n="</"+r+">";return e.indexOf(t)>-1?e.substring(e.indexOf(t)+t.length,e.indexOf(n)):null}if(!e)return null;var n={};return r.example.forEach(function(e){n[e]=t(e)}),n}function markdown(e){return e}function constructDocItem(e,r,t,n,o){function s(){if(i){var e,r=trim(l.join("\n"));if("module"==i)e=r.match(/^\s*(\S+)\s*$/),e&&(p.moduleName=e[1]);else if("param"==i){if(p.parameters||(p.parameters=[]),e=r.match(/^\{([^}]+)\}\s+(([^\s=]+)|\[(\S+)=([^\]]+)\])\s+(.*)/),!e)throw new Error("Not a valid 'param' format: "+r+" (found in: "+p.file+":"+p.line+")");var t="="===e[1].slice(-1),n={name:e[4]||e[3],description:markdown(r.replace(e[0],e[6])),type:t?e[1].substring(0,e[1].length-1):e[1],optional:t,"default":e[5]},o=n.name.indexOf(".");if(o>0){n.isProperty=!0;var s=n.name.substr(0,o),a=n.name.substr(o+1);n.name=a;var c=p.parameters.filter(function(e){return e.name===s})[0];c&&(c.properties=c.properties||[],c.properties.push(n))}else p.parameters.push(n)}else if("returns"==i||"return"==i){if(e=r.match(/^\{([^}]+)\}\s+(.*)/),!e)throw new Error("Not a valid 'returns' format: "+r+" (found in: "+p.file+":"+p.line+")");p.returns={type:e[1],description:markdown(r.replace(e[0],e[2]))}}else if("requires"==i)e=r.match(/^([^\s]*)\s*([\S\s]*)/),p.requires.push({name:e[1],text:markdown(e[2])});else if("property"==i){if(e=r.match(/^\{(\S+)\}\s+(\S+)(\s+(.*))?/),!e)throw new Error("Not a valid 'property' format: "+r+" (found in: "+p.file+":"+p.line+")");var u=new Doc({type:e[1],name:e[2],shortName:e[2],description:markdown(r.replace(e[0],e[4]))});p.properties.push(u)}else"eventType"==i?(e=r.match(/^([^\s]*)\s+on\s+([\S\s]*)/),p.type=e[1],p.target=e[2]):"constructor"==i?p.constructor=!0:p[i]=r}}function a(e){return e.replace(/(?:^\w|[A-Z]|\b\w|\s+)/g,function(e,r){return 0===+e?"":0===r?e.toLowerCase():e.toUpperCase()})}var i,l,c,p={};r.split(NEW_LINE).forEach(function(e){(c=e.match(/^\s*@(\w+)(\s+(.*))?/))?(s(),i=c[1],l=[],c[3]&&l.push(c[3].trim())):i&&l.push(e)}),s(),p.shortName=a(p.name),p.id=p.id||p.shortName,p.example=parseExample(p.example,o),p[o.denominator]={source:path.relative(o.dest,e),line:{from:t,to:n}},GENEROUS.push(p)}function parseSrcFiles(e,r,t){var n,o,s,a=r.toString().split(NEW_LINE),i=!1,l=new RegExp("@"+t.denominator);a.forEach(function(r,a){a++,!i&&(n=r.match(/^\s*\/\*\*\s*(.*)$/))&&(r=n[1],i=!0,o=[],s=a),i&&r.match(/\*\//)&&(o=o.join("\n"),o=o.replace(/^\n/,""),o.match(l)&&docs.push(constructDocItem(e,o,s,a,t)),i=!1),i&&o.push(r.replace(/^\s*\*\s?/,""))})}function keysrt(e,r){return function(t,n){return r?~~(t[e]<n[e]):~~(t[e]>n[e])}}function generous(e){e=e||{},e.dest=e.dest||argv.dest||"generous",e.denominator=e.denominator||"generous",e.example=e.example||["html","javascript","css","head"],e.sourceLink=e.sourceLink||!0,e.src=argv.src||e.src,e.title=e.title||"generous",e.dest.replace(/\/+$/,""),e.sourceEditor=e.sourceEditor||"plunker";var r=0;console.time("Completed in"),console.log("\nGenerous started...\n"),"object"!=typeof e.src&&(e.src=[e.src]);var t=function(e){var r=q.defer();return glob(e,function(t,n){t?(console.log("  "+chalk.red("×")+" Failed to resolve "+n+" from glob "+e+"\n\n"),r.reject(t)):r.resolve(n)}),r.promise},n=function(t){var n=q.defer();return fs.readFile(t,"utf8",function(o,s){r++,o?(console.log("  "+chalk.red("×")+" Failed to parse "+t),n.reject(o)):(parseSrcFiles(t,s,e),console.log("  "+chalk.green("✔")+" Parsed "+t),n.resolve())}),n.promise};return q.all(e.src.map(t)).then(function(e){var r=[].concat.apply([],e);return q.all(r.map(n))}).then(function(){fs.copy(__dirname+"/../app",e.dest,{clobber:!0},function(t){return t?void console.log(chalk.red("Error copying app files from "+__dirname+"/../app to "+e.dest+"/index.html")):(e.template&&fs.copy(e.template,e.dest+"/index.html",{clobber:!0},function(r){return r?void console.log(chalk.red("Error copying template from "+e.template+" to "+e.dest+"/index.html")):void 0}),fs.writeJson(e.dest+"/data/generous.json",{options:e,data:getNestedChildren(GENEROUS.sort(keysrt(e.denominator)))},function(r){return r?void console.log(chalk.red("Error writing data file to: "+e.dest+"/data/generous.json")):void 0}),console.log("\nGenerous finished: "+r+" files and "+GENEROUS.length+" items"),console.timeEnd("Completed in"),void console.log(""))})})}var glob=require("glob"),path=require("path"),q=require("q"),chalk=require("chalk"),NEW_LINE=/\n\r?/,docs=[],fs=require("fs-extra"),argv=require("minimist")(process.argv.slice(2)),GENEROUS=[];argv.src&&generous(),module.exports=generous;